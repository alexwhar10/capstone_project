{% extends "base.html" %}
{% block content %}

<div class="card">
    <h1>üëã Welcome, {{ username }}!</h1>

    {% if message %}
    <div class="alert alert-success">
        ‚úì {{ message }}
    </div>
    {% endif %}
</div>

<!-- Metrics Overview -->
<div class="card">
    <h2>üìä Ansible Job Metrics</h2>

    <div class="grid">
        <div class="stat-card">
            <h3>Currently Running</h3>
            <div class="stat-value" id="running-jobs">0</div>
            <p style="opacity: 0.9;">Active Jobs</p>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
            <h3>Total Jobs</h3>
            <div class="stat-value" id="total-jobs-count">0</div>
            <p style="opacity: 0.9;">All Time</p>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <h3>Avg Duration</h3>
            <div class="stat-value" id="avg-duration">0s</div>
            <p style="opacity: 0.9;">Per Job</p>
        </div>
    </div>

    <h3 style="margin-top: 2rem;">üìã Job History</h3>
    <table>
        <thead>
            <tr>
                <th>Playbook</th>
                <th>Status</th>
                <th>User</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody id="job-history">
            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Loading metrics...</td></tr>
        </tbody>
    </table>

    <h3 style="margin-top: 2rem;">‚è±Ô∏è Average Duration by Playbook</h3>
    <table>
        <thead>
            <tr>
                <th>Playbook</th>
                <th>Avg Duration</th>
                <th>Total Runs</th>
            </tr>
        </thead>
        <tbody id="duration-stats">
            <tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
function updateMetrics() {
    fetch('/api/metrics/summary')
        .then(response => response.json())
        .then(data => {
            document.getElementById('running-jobs').textContent = data.running_jobs;

            const totalCount = data.total_jobs.reduce((sum, job) => sum + job.count, 0);
            document.getElementById('total-jobs-count').textContent = totalCount;

            const tbody = document.getElementById('job-history');
            if (data.total_jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No jobs run yet</td></tr>';
            } else {
                tbody.innerHTML = data.total_jobs.map(job => `
                    <tr>
                        <td><strong>${job.playbook}</strong></td>
                        <td>
                            <span class="badge ${job.status === 'successful' ? 'badge-success' : 'badge-danger'}">
                                ${job.status === 'successful' ? '‚úì' : '‚úó'} ${job.status}
                            </span>
                        </td>
                        <td>${job.user}</td>
                        <td><strong>${job.count}</strong></td>
                    </tr>
                `).join('');
            }

            // Update average duration stats
            const durationTbody = document.getElementById('duration-stats');
            if (data.duration_stats && data.duration_stats.length > 0) {
                const overallAvg = data.duration_stats.reduce((sum, d) => sum + d.avg_seconds * d.total_runs, 0)
                    / Math.max(data.duration_stats.reduce((sum, d) => sum + d.total_runs, 0), 1);
                document.getElementById('avg-duration').textContent = overallAvg.toFixed(1) + 's';

                durationTbody.innerHTML = data.duration_stats.map(d => `
                    <tr>
                        <td><strong>${d.playbook}</strong></td>
                        <td>${d.avg_seconds}s</td>
                        <td><strong>${d.total_runs}</strong></td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('avg-duration').textContent = '0s';
                durationTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">No duration data yet</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error fetching metrics:', error);
        });
}

updateMetrics();
setInterval(updateMetrics, 5000);
</script>

<!-- Run Playbook Section -->
<div class="card">
    <h2>üéØ Run Ansible Playbook</h2>
    <form method="POST" action="{{ url_for('run_playbook_dashboard') }}">
        <label for="playbook">Select Playbook</label>
        <select name="playbook" id="playbook">
            {% for pb in allowed_playbooks %}
            <option value="{{ pb }}">{{ pb }}</option>
            {% endfor %}
        </select>

        <label for="extra_vars">Extra Variables (JSON)</label>
        <input type="text" name="extra_vars" id="extra_vars" placeholder='{"key":"value"}'>

        <button type="submit" class="btn btn-primary">‚ñ∂Ô∏è Run Playbook</button>
    </form>
</div>


{% endblock %}
