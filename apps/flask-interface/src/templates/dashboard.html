{% extends "base.html" %}
{% block content %}

<div class="card">
    <h1>üëã Welcome, {{ username }}!</h1>

    {% if message %}
    <div class="alert alert-success">
        ‚úì {{ message }}
    </div>
    {% endif %}
</div>

<!-- Metrics Overview -->
<div class="card">
    <h2>üìä Ansible Job Metrics</h2>

    <div class="grid">
        <div class="stat-card">
            <h3>Currently Running</h3>
            <div class="stat-value" id="running-jobs">0</div>
            <p style="opacity: 0.9;">Active Jobs</p>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
            <h3>Total Jobs</h3>
            <div class="stat-value" id="total-jobs-count">0</div>
            <p style="opacity: 0.9;">All Time</p>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <h3>Avg Duration</h3>
            <div class="stat-value" id="avg-duration">0s</div>
            <p style="opacity: 0.9;">Per Job</p>
        </div>
    </div>

    <h3 style="margin-top: 2rem;">üìã Job History</h3>
    <table>
        <thead>
            <tr>
                <th>Playbook</th>
                <th>Status</th>
                <th>User</th>
                <th>Source</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody id="job-history">
            <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">Loading metrics...</td></tr>
        </tbody>
    </table>

    <h3 style="margin-top: 2rem;">‚è±Ô∏è Average Duration by Playbook</h3>
    <table>
        <thead>
            <tr>
                <th>Playbook</th>
                <th>Avg Duration</th>
                <th>Total Runs</th>
            </tr>
        </thead>
        <tbody id="duration-stats">
            <tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
async function safeFetch(url, options) {
    const r = await fetch(url, options);
    const contentType = r.headers.get('content-type');
    
    // Check if response is JSON
    if (contentType && contentType.includes('application/json')) {
        const data = await r.json();
        if (!r.ok) {
            // Throw JSON error message if available
            throw new Error(data.error || `HTTP ${r.status}: ${JSON.stringify(data)}`);
        }
        return data;
    } else {
        // Non-JSON response (likely HTML error page)
        const text = await r.text();
        throw new Error(`HTTP ${r.status}: ${text.substring(0, 200)}`);
    }
}

function updateMetrics() {
    safeFetch('/api/metrics/summary')
        .then(data => {
            document.getElementById('running-jobs').textContent = data.running_jobs;

            const totalCount = data.total_jobs.reduce((sum, job) => sum + job.count, 0);
            document.getElementById('total-jobs-count').textContent = totalCount;

            const tbody = document.getElementById('job-history');
            if (data.total_jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No jobs run yet</td></tr>';
            } else {
                tbody.innerHTML = data.total_jobs.map(job => `
                    <tr>
                        <td><strong>${job.playbook}</strong></td>
                        <td>
                            <span class="badge ${job.status === 'successful' ? 'badge-success' : 'badge-danger'}">
                                ${job.status === 'successful' ? '‚úì' : '‚úó'} ${job.status}
                            </span>
                        </td>
                        <td>${job.user}</td>
                        <td>${job.source || 'manual'}</td>
                        <td><strong>${job.count}</strong></td>
                    </tr>
                `).join('');
            }

            // Update average duration stats
            const durationTbody = document.getElementById('duration-stats');
            if (data.duration_stats && data.duration_stats.length > 0) {
                const overallAvg = data.duration_stats.reduce((sum, d) => sum + d.avg_seconds * d.total_runs, 0)
                    / Math.max(data.duration_stats.reduce((sum, d) => sum + d.total_runs, 0), 1);
                document.getElementById('avg-duration').textContent = overallAvg.toFixed(1) + 's';

                durationTbody.innerHTML = data.duration_stats.map(d => `
                    <tr>
                        <td><strong>${d.playbook}</strong></td>
                        <td>${d.avg_seconds}s</td>
                        <td><strong>${d.total_runs}</strong></td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('avg-duration').textContent = '0s';
                durationTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">No duration data yet</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error fetching metrics:', error);
            // Show error in UI
            const tbody = document.getElementById('job-history');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ef4444;">Error loading metrics: ' + error.message + '</td></tr>';
        });
}

updateMetrics();
setInterval(updateMetrics, 5000);
</script>

<!-- Scheduled Jobs Section (admin only) -->
{% if role == 'admin' %}
<div class="card">
    <h2>üìÖ Scheduled Jobs</h2>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Playbook</th>
                <th>Cron Schedule</th>
                <th>Status</th>
                <th>Created By</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="schedules-table">
            <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
        </tbody>
    </table>

    <h3 style="margin-top: 1.5rem;">Create New Schedule</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div>
            <label for="sched-name">Name</label>
            <input type="text" id="sched-name" placeholder="nightly-ping">
        </div>
        <div>
            <label for="sched-playbook">Playbook</label>
            <select id="sched-playbook">
                {% for pb in allowed_playbooks %}
                <option value="{{ pb }}">{{ pb }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="sched-cron">Cron Expression</label>
            <input type="text" id="sched-cron" placeholder="0 3 * * *">
        </div>
    </div>
    <div style="margin-top: 0.5rem;">
        <label for="sched-vars">Extra Variables (JSON)</label>
        <input type="text" id="sched-vars" placeholder='{}'>
    </div>
    <button class="btn btn-primary" onclick="createSchedule()" style="margin-top: 0.5rem;">+ Create Schedule</button>
    <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
        Cron format: minute hour day month weekday &mdash; e.g. <code>0 3 * * *</code> = daily at 3:00 AM,
        <code>0 12 * * 1</code> = every Monday at noon
    </p>
</div>

<script>
function loadSchedules() {
    safeFetch('/api/schedules')
        .then(schedules => {
            const tbody = document.getElementById('schedules-table');
            if (!schedules.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-secondary);">No scheduled jobs</td></tr>';
                return;
            }
            tbody.innerHTML = schedules.map(s => `
                <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.playbook}</td>
                    <td><code>${s.cron_expression}</code></td>
                    <td>
                        <span class="badge ${s.enabled ? 'badge-success' : 'badge-danger'}"
                              style="cursor:pointer"
                              onclick="toggleSchedule(${s.id}, ${!s.enabled})">
                            ${s.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>${s.created_by}</td>
                    <td>
                        <button class="btn btn-danger" style="padding:0.3rem 0.6rem; font-size:0.8rem;"
                                onclick="deleteSchedule(${s.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(err => console.error('Error loading schedules:', err));
}

function createSchedule() {
    const body = {
        name: document.getElementById('sched-name').value,
        playbook: document.getElementById('sched-playbook').value,
        cron_expression: document.getElementById('sched-cron').value,
        extra_vars: document.getElementById('sched-vars').value || '{}',
    };
    safeFetch('/api/schedules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body),
    })
    .then(data => {
        if (data.error) { alert(data.error); return; }
        document.getElementById('sched-name').value = '';
        document.getElementById('sched-cron').value = '';
        document.getElementById('sched-vars').value = '';
        loadSchedules();
    })
    .catch(err => alert('Error: ' + err.message));
}

function toggleSchedule(id, enabled) {
    safeFetch(`/api/schedules/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled}),
    }).then(() => loadSchedules())
      .catch(err => console.error('Toggle error:', err));
}

function deleteSchedule(id) {
    if (!confirm('Delete this schedule?')) return;
    safeFetch(`/api/schedules/${id}`, {method: 'DELETE'})
        .then(() => loadSchedules())
        .catch(err => alert('Delete error: ' + err.message));
}

loadSchedules();
setInterval(loadSchedules, 15000);
</script>
{% endif %}

<!-- Run Playbook Section -->
<div class="card">
    <h2>üéØ Run Ansible Playbook</h2>
    <form method="POST" action="{{ url_for('run_playbook_dashboard') }}">
        <label for="playbook">Select Playbook</label>
        <select name="playbook" id="playbook">
            {% for pb in allowed_playbooks %}
            <option value="{{ pb }}">{{ pb }}</option>
            {% endfor %}
        </select>

        <label for="extra_vars">Extra Variables (JSON)</label>
        <input type="text" name="extra_vars" id="extra_vars" placeholder='{"key":"value"}'>

        <button type="submit" class="btn btn-primary">‚ñ∂Ô∏è Run Playbook</button>
    </form>
</div>


{% endblock %}
